(function(e,t){typeof define=="function"&&define.amd?define(["eventemitter2"],t):e.ROS=t(e.EventEmitter2)})(this,function(e){var t=function(t){function r(e){n.emit("connection",e)}function i(e){n.emit("close",e)}function s(e){n.emit("error",e)}function o(e,t){var n=new Image;n.onload=function(){var e=document.createElement("canvas"),r=e.getContext("2d");e.width=n.width,e.height=n.height,r.drawImage(n,0,0);var i=r.getImageData(0,0,n.width,n.height).data,s="";for(var o=0;o<i.length;o+=4)s+=String.fromCharCode(i[o],i[o+1],i[o+2]);var u=JSON.parse(s);t(u)},n.src="data:image/png;base64,"+e.data}function u(e){function t(e){e.op==="publish"?n.emit(e.topic,e.msg):e.op==="service_response"&&n.emit(e.id,e.values)}var r=JSON.parse(e.data);r.op==="png"?o(r,function(e){t(e)}):t(r)}function a(e){var t=JSON.stringify(e);n.socket.readyState!==WebSocket.OPEN?n.once("connection",function(){n.socket.send(t)}):n.socket.send(t)}var n=this;n.socket=null,n.idCounter=0,n.connect=function(e){n.socket=new WebSocket(e),n.socket.onopen=r,n.socket.onclose=i,n.socket.onerror=s,n.socket.onmessage=u},n.close=function(){n.socket&&n.socket.close()},t&&n.connect(t),n.getTopics=function(e){var t=new n.Service({name:"/rosapi/topics",serviceType:"rosapi/Topics"}),r=new n.ServiceRequest;t.callService(r,function(t){e(t.topics)})},n.Message=function(e){var t=this;e&&Object.keys(e).forEach(function(n){t[n]=e[n]})},n.Topic=function(e){var t=this;e=e||{},t.node=e.node,t.name=e.name,t.messageType=e.messageType,t.isAdvertised=!1,t.compression=e.compression||"none",t.compression&&t.compression!=="png"&&t.compression!=="none"&&t.emit("warning",t.compression+" compression is not supported. No comression will be used."),t.subscribe=function(e){t.on("message",function(t){e(t)}),n.on(t.name,function(e){var r=new n.Message(e);t.emit("message",r)}),n.idCounter++;var r="subscribe:"+t.name+":"+n.idCounter,i={op:"subscribe",id:r,type:t.messageType,topic:t.name,compression:t.compression};a(i)},t.unsubscribe=function(){n.removeAllListeners([t.name]),n.idCounter++;var e="unsubscribe:"+t.name+":"+n.idCounter,r={op:"unsubscribe",id:e,topic:t.name};a(r)},t.advertise=function(){n.idCounter++;var e="advertise:"+t.name+":"+n.idCounter,r={op:"advertise",id:e,type:t.messageType,topic:t.name};a(r),t.isAdvertised=!0},t.unadvertise=function(){n.idCounter++;var e="unadvertise:"+t.name+":"+n.idCounter,r={op:"unadvertise",id:e,topic:t.name};a(r),t.isAdvertised=!1},t.publish=function(e){t.isAdvertised||t.advertise(),n.idCounter++;var r="publish:"+t.name+":"+n.idCounter,i={op:"publish",id:r,topic:t.name,msg:e};a(i)}},n.Topic.prototype.__proto__=e.prototype,n.getServices=function(e){var t=new n.Service({name:"/rosapi/services",serviceType:"rosapi/Services"}),r=new n.ServiceRequest;t.callService(r,function(t){e(t.services)})},n.ServiceRequest=function(e){var t=this;e&&Object.keys(e).forEach(function(n){t[n]=e[n]})},n.ServiceResponse=function(e){var t=this;e&&Object.keys(e).forEach(function(n){t[n]=e[n]})},n.Service=function(e){var t=this;e=e||{},t.name=e.name,t.serviceType=e.serviceType,t.callService=function(e,r){n.idCounter++,serviceCallId="call_service:"+t.name+":"+n.idCounter,n.once(serviceCallId,function(e){var t=new n.ServiceResponse(e);r(t)});var i=[];Object.keys(e).forEach(function(t){i.push(e[t])});var s={op:"call_service",id:serviceCallId,service:t.name,args:i};a(s)}},n.Service.prototype.__proto__=e.prototype,n.getParams=function(e){var t=new n.Service({name:"/rosapi/get_param_names",serviceType:"rosapi/GetParamNames"}),r=new n.ServiceRequest;t.callService(r,function(t){e(t.names)})},n.Param=function(e){var t=this;e=e||{},t.name=e.name,t.get=function(e){var r=new n.Service({name:"/rosapi/get_param",serviceType:"rosapi/GetParam"}),i=new n.ServiceRequest({name:t.name,value:JSON.stringify("")});r.callService(i,function(t){var n=JSON.parse(t.value);e(n)})},t.set=function(e){var r=new n.Service({name:"/rosapi/set_param",serviceType:"rosapi/SetParam"}),i=new n.ServiceRequest({name:t.name,value:JSON.stringify(e)});r.callService(i,function(){})}},n.Param.prototype.__proto__=e.prototype};return t.prototype.__proto__=e.prototype,t});